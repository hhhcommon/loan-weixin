<!DOCTYPE html>
<html>
	<head>
		<META HTTP-EQUIV="pragma" CONTENT="no-cache">  
		<META HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate">  
		<META HTTP-EQUIV="expires" CONTENT="0">	
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta name="format-detection" content="telephone=no,date=no,address=no">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<title>申请分期</title>
		<link rel="stylesheet" type="text/css" href="../css/base.min.css" />
		<link rel="stylesheet" type="text/css" href="../css/huiflex.min.css" />
		<link rel="stylesheet" type="text/css" href="../css/loadingm.css" />
		<link rel="stylesheet" type="text/css" href="../guidance/css/iconfont.css"/>
		<style type="text/css">
			body {
				color: #333;
			}
			.inputbg {
				padding: 12px 15px;
				/*border-bottom: 1px solid #dbd9da;*/
				border-bottom: 1px solid #F2F2F2;
			}
			
			.inputbg input {
				text-align: right;
				font-size: 18px;
				outline: none;
				border: none;
			}
			
			.btn {
				background: #2c8ef3;
				text-align: center;
				color: white;
				padding: 10px;
				font-size: 16px;
				border-radius: 6px;
				margin: 15px;
			}
			
			.fc {
				color: #999999;
			}
			
			.check {
				color: #2c8ef3;
				/*border-bottom: 1px solid #2c8ef3;*/
			}
			
			.mathbtn {
				width: 60px;
				text-align: center;
				background: #2c8ef3;
				color: white;
				height: 30px;
				line-height: 30px;
			}
			
			.btn-left {
				border-radius: 9px 0 0 9px;
			}
			
			.btn-right {
				border-radius: 0 9px 9px 0;
			}
			
			.dlist {
				height: 150px;
				overflow-y: scroll;
				overflow-x: hidden;
			}
			
			.dlist>li {
				text-align: center;
				padding: 10px 5px;
			}
			.error{color: #fff;background: rgba(0,0,0,0.4);text-align: center;line-height: 50px;position: fixed;top: 0;left: 0;right: 0;bottom: 0;z-index: 100;}
			.error .error_msg{background: rgba(0,0,0,0.6);position: fixed;top: 35%;left: 20px;right: 20px;z-index: 100;border-radius: 5px;}
			.jh{
				padding: 12px 15px;
				display: flex;
				justify-content: space-between;
			}
			.ze{
				font-size: 12px;
				color: #999999;
			}
			.top{
				padding: 12px 15px;
			}
			.text_center{
				text-align: center;
			}
			.money{
				font-size: 30px;
				font-weight: 600;
				margin: 0 10px;
			}
			.sqje{
				padding: 5px;
			}
			.padding{
				padding: 12px 15px 20px 15px;
			}
			._hidden{
				display: none;
			}
			.jihua_list{
				border-top: 1px solid #F2F2F2;
			}
			.jihua_list table{
				width: 100%;
			}
			.jihua_list table td{
				width:25%;
				padding: 10px 0;
			}
			.td_last{
				color: #2C8EF3;
				text-align: right;
			}
			.jhnr{
				margin-right: 10px;
			}
			.checkImg{
				padding: 8px 8px;
			}
		</style>
	</head>

	<body>
		<div id="mainPage">
			<div class="" style="background: white;">
				<div class="top">
					<div class="text_center sqje">申请金额</div>
					<div class="text_center"><span class="fuhao">￥</span><span id="amount" class="money"></span>
					</div>
				</div>
				
				<div class="hui-flex justify-between inputbg" id="credit_btn">
					<div id="" style="width: 100px;">归还计划</div>
					<div class="" style="font-size: 16px;" id="creditnum">分期数/息费*<span class="jhnr" id="periods"></span><img src="../img/down.png" style="width: 14px;"/><img src="../img/up.png" style="width: 14px;" class="_hidden"/><p class="ze">归还总额￥<span class="money_sum" id="totalMoeny"></span></p></div>
				</div>


				<div class="jihua_list padding _hidden">
					<table id="jl_table">

					</table>
				</div>
				
				<div class="hui-flex justify-between inputbg">
					<div id="" style="width: 75px;">归还方式</div>
					<div id="" class="fc">每月等额本金 </div>
				</div>
			</div>

			<div class="" style="background: white;">
				<div class="hui-flex justify-between inputbg">
					<div style="width: 110px;">首期归还金额</div>
					<div class="" style="color: #2C8EF3;font-size: 16px;">￥ <span id="fristRePay">0</span></div>
				</div>
				
				<div class="hui-flex justify-between inputbg">
					<div id="" style="width: 75px;">首期归还日</div>
					<div id="current_repay_date" class="fc">年月日</div>
				</div>
				<div class="hui-flex justify-between inputbg" id="repaydetails">
					<div id="" style="width: 75px;">转入账户</div>
					<div id="account" class="check" ></div>
				</div>
			</div>
			<div class="" style="background: white;">
				<div class="" style="background: white;">
					<div id="mscenepar" class="hui-flex justify-between inputbg">
						<div id="" style="width: 75px;">资金用途</div>
						<div id="mscene" class="fc">请选择 <span class="iconfont icon-gengduo" style="font-size: 13px;font-weight: bold;"></span></div>
					</div>
				</div>
			</div>

			<div id="" class="fc" style="padding: 10px 15px;">
				<div style="font-size: 12px;line-height: 18px;">请选择资金的实际用途，禁止用于购房，投资及各种非消费场景</div>
				<span id="contractpar"><img src="../img/unchecked.png" style="vertical-align: middle;width: 16px;height: 16px;margin: -2px 6px 0 0;"/>我已阅读并同意 <a href="javascript:void(0)" style="color: #2c8ef3">《租金支付计划表》</a> </span>
			</div>
			<div class="" style="width: 100%;">
				<div class="btn" style="background: #999999;" id="bor_btn">
					申 请
				</div>
			</div>
		</div>
		<div id="myModal" class="loading-modal" style="display: none;">
			<!-- Modal content -->
			<div class="loading-modal-content">
				<img src="../img/default.svg" style="vertical-align: middle;width: 3em;margin-left: 1em;" />
				<span id="" style="vertical-align: middle;margin-left: 1em">
					数据加载中...
				</span>
			</div>
		</div>

		<div id="bsModal" class="loading-modal" style="display: none;">
			<!-- Modal content -->
			<div class="loading-modal-content " style="width: 75%;">
				<div class="fc" style="text-align: left;border-bottom: 1px solid #A9C8E8;padding: 10px;font-size: 14px;">
					请选择资金的实际用途
					<br /> 禁止用于购房，投资及各种非消费场景
				</div>
				<div class="">
					<ul class="dlist" id="bslist">
					</ul>
				</div>

			</div>
		</div>
		<script src="../js/fastclick.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/zepto.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/util_v1.4.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			$(function(){

				$("#credit_btn").click(function() {
					$(this).find("img").toggleClass("_hidden");
					$(this).next(".jihua_list").toggleClass("_hidden");
				});


                $("span.checkImg").live("click",function () {
					var imgUrl=$(this).find("img").attr("src");
					if(imgUrl.indexOf("unchecked.png")!=-1){
                        $("span.checkImg").find("img").attr("src","../img/unchecked.png");
                        $(this).find("img").attr("src","../img/checked.png");
					}else{
                        $(this).find("img").attr("src","../img/unchecked.png");
					}
					var dataJson=$(this).find("img").attr("data");
					data=JSON.parse(dataJson.replace(/\\\"/g,"\""));
                    initInfoTable(data);
                })
				
				$("#contractpar").click(function () {
                    if($('#mscene').attr("data-val") && $('#mscene').attr("data-val").length > 0) {
                        goContract();
                    } else {
                        error("请先选择资金用途");
                    }
                })
				

				var amount = GetQueryString("a");
				var id = GetQueryString("id");
				if(!amount || !id) {
					error("必要参数不存在");
					return;
				}
				$('#amount').text(amount);
				setTimeout(function(){
					getData({
						"amount": amount,
						"userId": utf8to16(decode64(id))
					});
					initEvent(id,amount);
				},200);
				//详情二级页面
                getBankCard();
				FastClick.attach(document.body);
				
			});
			function getData(param) {
				$('#myModal').show();
				postSerDataWithHeader('/wechat/borrow/api/repayPlanList.shtml', param, initData, '微信授权');
				$('#myModal').hide();
			}
			function initData(data) {
				if(data.success) {
					initTable(data.data.items);
				} else {
					error(data.message);
				}
			}
			function initTable(items) {
				for(var i = 0; i < items.length; i++) {
                    var k = i;
                    var checkedHtml;
                    var dataParam={
                        current_repay_amount:items[k].current_repay_amount,
                        current_repay_date:items[k].current_repay_date,
                        periods:items[k].periods
                    };

                    var imgData=dataParam;
                    var plans=items[i].plans;
                    if(plans){
						var totalMoeny=0;
						for(var j=0;j<plans.length;j++){
                            totalMoeny+=Number(plans[j].amount);
						}
						imgData.totalMoeny=totalMoeny.toFixed(2);
						imgData.rate=items[k].rate;
					}
                    dataParamJson=JSON.stringify(imgData).replace(/\"/g,"\\\"");
                    var periods="30";
                    if(localStorage.existHistoryParkingBorrow){
                        var existHistoryParkingBorrow=JSON.parse(localStorage.existHistoryParkingBorrow);
                        periods=existHistoryParkingBorrow.periods;
                    }
                    if(items[k].periods==periods){
                        checkedHtml="<span class='checkImg'><img  data='"+dataParamJson+"' src=\"../img/checked.png\" style=\"width: 15px; vertical-align: middle;margin: -2px 0 0 16%;\"/></span>";
                        initInfoTable(dataParam);
                    }else{
                        checkedHtml="<span class='checkImg'><img  data='"+dataParamJson+"' src=\"../img/unchecked.png\" style=\"width: 15px; vertical-align: middle;margin: -2px 0 0 16%;\"/></span>";
                    }
                    var param={
                        periods:items[k].periods,
                        rate:items[k].rate
                    }
                    var paramJson=JSON.stringify(param).replace(/\"/g,"'");
                    var html = '<tr><td class="qs">' + items[k].periods + '个月</td><td class="dq">' + Number(items[k].current_repay_amount).toFixed(2) + '</td><td class="zs">' + Number(items[k].total_amount).toFixed(2) + '</td><td class="td_last"><span onClick="detailInfo('+paramJson+')">详情</span> '+checkedHtml+'</td></tr>';
                    $('#jl_table').append(html);
				}





			}
            function detailInfo(data) {

			    var checkedData=getCheckedData();
				var param={
                    periods:checkedData.periods,
                    mscene: $("#mscene").attr("data-val"),
					msceneText: $("#mscene").text()
				}
                localStorage.existHistoryParkingBorrow=JSON.stringify(param);
                window.location.href = "mortgage/tempborrowplan.html" + location.search + "&p=" + data.periods + "&r=" + data.rate;
            }


            function initInfoTable(data) {
				$("#fristRePay").text(data.current_repay_amount);
				$("#current_repay_date").text(getDateFormatStr(new Date(Number(data.current_repay_date))));
				$("#periods").text(data.periods+"期");
				$("#totalMoeny").text(data.totalMoeny);

            }


			//详情二级页面
			var mortgage_scenes;
			function getScenes() {
				$('#myModal').show();
				setTimeout(function() {
					postSerDataWithHeader('/wechat/user/api/basecodeList.shtml', {
						"id": "mortgage_scenes"
					}, initScenes, '初始化期限');
					$('#myModal').hide();
					$('#bsModal').show();
				}, 200);
			}

			function initScenes(data) {
				if(data.success) {
					mortgage_scenes = data.data.items;
					var items = data.data.items;
					for(var i = 0; i < items.length; i++) {
						(function() {
							var k = i;
							var item = items[k];
							var li = $("<li>" + item.descript + "</li>");
							$(li).click(function() {
								$('#mscene').text(item.descript);
								$('#mscene').attr("data-val", item.code);
								$('#bsModal').hide();
							});
							$('.dlist').append(li);
						})()
					}
				} else {
					error(data.message);
				}

			}


			function initEvent(data) {
			    if(localStorage.existHistoryParkingBorrow){
			        var existHistoryParkingBorrow=JSON.parse(localStorage.existHistoryParkingBorrow);
                    $('#mscene').text(existHistoryParkingBorrow.msceneText);
                    $('#mscene').attr("data-val", existHistoryParkingBorrow.mscene);
				}
				$('#mscenepar').click(function() {
					if(!mortgage_scenes) {
						getScenes();
					}else{
						$('#bsModal').show();
					}
					
				});
			}
			
			function afterContract(data) {
				if(data.success) {
                    $('#myModal').hide();
					window.location.href=data.data.url;
				} else {
					error(data.message);
				}
			}

			function goContract() {
                var checkedData=getCheckedData();
                if(!checkedData){
					error("请至少选中一个分期");
					return;
				}
				$('#myModal').show();
				setTimeout(function() {
                    var cwobj = JSON.parse(localStorage.caiweiObj);
                    var userId = cwobj.userId;
				    var data={
                        scenes:$('#mscene').text(),
                        amount:GetQueryString("a"),
						userId:userId,
                        rate:checkedData.rate,
                        periods:checkedData.periods
					};
                    var scenes_desc=$('#mscene').text();
                    var periods_desc=checkedData.periods+"个月";
                    var scenesStr=$('#mscene').attr("data-val");
					data.returnUrl=location.href.replace("borrow_car.html","mortgage/parkCall.html")+"&pd="+ encode64(utf16to8(periods_desc)) +"&s="+scenesStr+"&sd="+encode64(utf16to8(scenes_desc))+"&r="+(checkedData.rate+"")+"&p="+checkedData.periods+"&timeStamp="+getTimeStamp();
					postSerDataWithHeader('/wechat/borrow/api/contract/mortgage.shtml', data,	afterContract, '提现协议');

				}, 200);
			}

			function getCheckedData() {
                var data;
                $("span.checkImg").find("img").each(function(item){
					var dataJson=$(this).attr("data");
					var imgUrl=$(this).attr("src");
					if(imgUrl=="../img/checked.png"){
                       if(dataJson){
                            data=JSON.parse(dataJson.replace(/\\\"/g,"\""));
                            return;
					   }
					}
				})
				return data;
            }
            function getBankCard() {
                if(localStorage.caiweiObj){
                    var caiweiObj=JSON.parse(localStorage.caiweiObj);
                    setTimeout(function(){
                        postSerDataWithHeader('/wechat/borrow/api/getBankCardInfo.shtml', {
                            "id":caiweiObj.userId
                        }, function (data) {
                            if(data.success){
                                var cardNo=data.data.cardNo;
                                var value=data.data.bank+"("+cardNo.substr(cardNo.length-4)+")";
                                $("#account").text(value);
                            }
                        }, '初始化银行');
                    },200);
                }
            }
			function afterApply(data) {
				if(data.success) {
					window.location.href = "applysuccess.html?timeStamp="+getTimeStamp();
				} else {
					error(data.message);
				}
			}



            function error(msg){
                $("body").append('<div class="error"><span class="error_msg"></span></div>');
                $(".error").show();
                $(".error_msg").html(msg);
                setTimeout(function(){
                    $(".error").remove();
                },1500);
            }
            
            
            

            
            
            
            
		</script>
	</body>

</html>